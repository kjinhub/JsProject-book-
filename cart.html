<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>장바구니</title>
    <link rel="stylesheet" href="cart.css" />
  </head>
  <body>
    <header>
      <div>
        <section class="login" id="signUpSection">
          <a href="javascript:void(0)" id="signU" onclick="showSignUpForm()">회원가입</a>
        </section>
        <section class="login" id="signInSection">
          <a href="javascript:void(0)" id="signI" onclick="showSignInForm()">로그인</a>
    </div>
    </section>
    <section class="login" id="logoutSection" style="display: none">
        <span id="userIdDisplay"></span>
        <span id="userPointsDisplay"></span>
        <a href="javascript:void(0)" id="logOut" onclick="logout()">로그아웃</a>
    </section>
    <div>
      <h1>장바구니</h1>
      <nav>
        <a href="main3.html">홈</a>
        <a href="book-list4.html">교재 목록</a>
        <a href="cart.html">장바구니</a>
      </nav>
    </header>
    
    <!-- 회원가입 폼 -->
    <div id="signUpForm" style="display: none">
      <h2>회원가입</h2>
      <div id="signUpForm1">
          <input type="text" id="signUpId" placeholder="아이디" required />
          <input type="password" id="signUpPassword" placeholder="비밀번호" required />
          <button onclick="signUp()">회원가입</button>
          <button onclick="hideSignUpForm()">취소</button>
      </div>
  </div>

  <!-- 로그인 폼 -->
  <div id="signInForm" style="display: none">
      <h2>로그인</h2>
      <div id="signInForm1">
          <input type="text" id="signInId" placeholder="아이디" required />
          <input type="password" id="signInPassword" placeholder="비밀번호" required />
          <button onclick="signIn()">로그인</button>
          <button onclick="hideSignInForm()">취소</button>
      </div>
  </div>

    <section class="cart-container">
      <h2>내 장바구니</h2>
      <div
        id="cartList"
        style="border: solid black 1px; width: 100%; height: 200px"
      ></div>
      <button id="removeAll" onclick="clearCart()">장바구니 비우기</button>
    </section>

    <script>
      // 초기화 시 로그인 상태 체크
      window.onload = function () {
        const isLoggedIn = localStorage.getItem("loggedIn");
        const userId = localStorage.getItem("userId");

        if (isLoggedIn === "true") {
          document.getElementById("signUpSection").style.display = "none";
          document.getElementById("signInSection").style.display = "none";
          document.getElementById("logoutSection").style.display = "block";

          // 사용자 아이디 표시
          document.getElementById("userIdDisplay").innerText = `${userId} 님`;

          // 사용자 포인트 표시
          const userPoints = localStorage.getItem("userPoints");
          document.getElementById(
            "userPointsDisplay"
          ).innerText = `포인트 : ${userPoints}`;
        } else {
          document.getElementById("signUpSection").style.display = "block";
          document.getElementById("signInSection").style.display = "block";
          document.getElementById("logoutSection").style.display = "none";
        }
      };

      // 회원가입
      function signUp() {
        const id = document.getElementById("signUpId").value;
        const password = document.getElementById("signUpPassword").value;

        if (!id || !password) {
          alert("아이디와 비밀번호를 입력하세요.");
          return;
        }

        // localStorage에 회원 정보 저장
        localStorage.setItem("userId", id);
        localStorage.setItem("userPassword", password);
        localStorage.setItem("userPoints", 0); // 기본 포인트 0 설정

        alert("회원가입이 완료되었습니다!");
        hideSignUpForm();
      }

      // 로그인
      function signIn() {
        const id = document.getElementById("signInId").value;
        const password = document.getElementById("signInPassword").value;
        const storedId = localStorage.getItem("userId");
        const storedPassword = localStorage.getItem("userPassword");

        if (id === storedId && password === storedPassword) {
          localStorage.setItem("loggedIn", "true");
          alert("로그인 성공!");
          location.reload(); // 페이지 새로고침하여 로그인 상태 반영
        } else {
          alert("아이디 또는 비밀번호가 틀렸습니다.");
        }
      }

      // 로그아웃
      function logout() {
        localStorage.removeItem("loggedIn");
        location.reload(); // 페이지 새로고침하여 로그아웃 상태 반영
      }

      // 로그인 폼과 회원가입 폼을 서로 다르게 보이게 하기
      function showSignUpForm() {
        document.getElementById("signInForm").style.display = "none"; // 로그인 폼 숨기기
        document.getElementById("signUpForm").style.display = "block"; // 회원가입 폼 보이기
      }

      function showSignInForm() {
        document.getElementById("signUpForm").style.display = "none"; // 회원가입 폼 숨기기
        document.getElementById("signInForm").style.display = "block"; // 로그인 폼 보이기
      }

      function hideSignUpForm() {
        document.getElementById("signUpForm").style.display = "none";
      }

      function hideSignInForm() {
        document.getElementById("signInForm").style.display = "none";
      }

      // localStorage에서 장바구니 항목 불러오기 및 렌더링
  // 장바구니 로드
  const cartList = document.getElementById("cartList");
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    
    function loadCarts() {
        cartList.innerHTML = ""; // 기존 항목 초기화
        cart.forEach((carts, index) => {
            const cartDiv = document.createElement("p");
            cartDiv.textContent = `책 이름: ${carts.name} | 출판사: ${carts.from} | 가격: ${carts.value} | 저자: ${carts.author}`;
            
            // 삭제 버튼
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "삭제";
            removeBtn.onclick = () => deleteCart(index);
            cartDiv.appendChild(removeBtn);

            // 구매 버튼
            const buyBtn = document.createElement("button");
            buyBtn.textContent = "구매하기";
            buyBtn.onclick = () => purchaseItem(index);
            cartDiv.appendChild(buyBtn);

            cartList.appendChild(cartDiv);
        });
    }
    loadCarts();
    function deleteCart(index){
        listRemove(index); //okay
        removeCart(index); //okay

    }
       // 장바구니 항목 삭제
    
 function purchaseItem(index) {

let updatedPoints = parseInt(localStorage.getItem("userPoints")) || 0;

  if(updatedPoints >= parseInt(cart[index].value)){
    alert("구매되었습니다");
    reducePoint(index); //okay
    listRemove(index); //okay
    removeCart(index); //okay

  }else{
    alert("포인트를 충전해주세요.")
  }
}

// 포인트 감소
function reducePoint(index) {
  let updatedPoints = parseInt(localStorage.getItem("userPoints")) || 0;
  if (updatedPoints < 0) updatedPoints = 0; // 음수 방지

    updatedPoints -= parseInt(cart[index].value); // 책 가격만큼 감소
  localStorage.setItem("userPoints", updatedPoints);
  window.onload()

  // document.getElementById("userPointsDisplay").innerText = `포인트 : ${currentPoints}`;

}
function removeCart(index) {
  cart.splice(index, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  loadCarts(); // 항목 제거 후 장바구니 새로고침
}

 // 구매 처리

function listRemove(index) {
  const books = JSON.parse(localStorage.getItem("books")) || []; // 'books'가 null일 수 있으므로 기본값 추가

  // books 배열을 역순으로 순회하며 cart와 일치하는 요소 삭제
  for (let i =0; i<= books.length; i++) {
    if (
      books[i].name === cart[index].name 
      &&books[i].from === cart[index].from 
      &&books[i].value === cart[index].value 
      &&books[i].author === cart[index].author
    ) {
      books.splice(i, 1);
    }
  }
  localStorage.setItem("cart", JSON.stringify(cart));

  // 수정된 books 배열을 다시 localStorage에 저장
  localStorage.setItem("books", JSON.stringify(books));

}
    // 장바구니 비우기
    function clearCart() {
        cart = [];
        localStorage.setItem("cart", JSON.stringify(cart));
        loadCarts();
    }
    </script>
  </body>
</html>
